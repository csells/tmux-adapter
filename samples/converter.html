<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Converter Dashboard</title>
<link rel="stylesheet" href="/shared/styles.css">
<style>
  /* Converter-dashboard-specific styles */
  .badge-runtime.claude { color: #a371f7; }
  .badge-runtime.codex { color: #3fb950; }
  .badge-runtime.gemini { color: #58a6ff; }

  .agent-conv-id {
    font-size: 10px;
    color: #484f58;
    margin-top: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .header-conv-id {
    color: #484f58;
    font-size: 11px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <button type="button" class="sidebar-close" id="sidebar-close" aria-label="Close drawer">&#xD7;</button>
      <span class="sidebar-title">Agents</span>
    </div>
    <div class="agent-list" id="agent-list">
      <div class="agent-list-state"><span class="spinner"></span><span>Loading agents...</span></div>
    </div>
  </div>

  <div class="main">
    <div class="main-header" id="main-header">
      <button type="button" class="mobile-nav-btn" id="mobile-nav-btn" aria-label="Open drawer">&#x2630;</button>
      <div class="header-content" id="header-content">Select an agent to view conversation</div>
      <div class="connection-status" id="connection-status">
        <span class="dot disconnected" id="status-dot"></span>
        <span id="status-text">Connecting...</span>
      </div>
    </div>
    <tmux-converter-web id="converter-view" style="display:none"></tmux-converter-web>
    <div class="placeholder" id="placeholder">Select an agent from the sidebar</div>
  </div>
</div>
<div class="drawer-backdrop" id="drawer-backdrop"></div>

<script type="module">
import { clearChildren, createBadge, isMobileLayout, openDrawer, closeDrawer, bindMobileLayoutEvents } from '/shared/utils.js';
import { encodeBinaryFrame, BinaryMsgType } from '/tmux-converter-web/index.js';

var converterHost = new URLSearchParams(location.search).get('converter') || location.host || 'localhost:8081';

// --- State ---
var agents = new Map();
var selectedAgent = null;
var currentConvId = null;
var currentSubId = null;
var ws = null;
var msgId = 0;
var handshakeDone = false;
var textEncoder = new TextEncoder();
var agentsLoading = true;
var agentsLoadTimedOut = false;
var agentsLoadTimer = null;
var AgentsLoadTimeoutMs = 7000;

// --- DOM refs ---
var agentListEl = document.getElementById('agent-list');
var headerContentEl = document.getElementById('header-content');
var placeholderEl = document.getElementById('placeholder');
var statusDot = document.getElementById('status-dot');
var statusText = document.getElementById('status-text');
var mobileNavBtn = document.getElementById('mobile-nav-btn');
var sidebarCloseBtn = document.getElementById('sidebar-close');
var drawerBackdropEl = document.getElementById('drawer-backdrop');
var converterEl = document.getElementById('converter-view');

// --- Agent loading state machine ---
function clearAgentsLoadTimer() {
  if (!agentsLoadTimer) return;
  clearTimeout(agentsLoadTimer);
  agentsLoadTimer = null;
}

function startAgentsLoading() {
  agentsLoading = true;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
  agentsLoadTimer = setTimeout(function() {
    if (!agentsLoading) return;
    agentsLoading = false;
    agentsLoadTimedOut = true;
    renderAgentList();
  }, AgentsLoadTimeoutMs);
  renderAgentList();
}

function markAgentsLoaded() {
  agentsLoading = false;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
}

// --- Mobile drawer ---
bindMobileLayoutEvents(mobileNavBtn, sidebarCloseBtn, drawerBackdropEl);

// --- Component events ---
converterEl.addEventListener('converter-send', async function(e) {
  var detail = e.detail;
  // Send files first as binary frames
  for (var i = 0; i < detail.files.length; i++) {
    var file = detail.files[i];
    var fileBytes = new Uint8Array(await file.arrayBuffer());
    var nameBytes = textEncoder.encode(file.name || 'attachment.bin');
    var mimeBytes = textEncoder.encode(file.type || 'application/octet-stream');
    var payload = new Uint8Array(nameBytes.length + 1 + mimeBytes.length + 1 + fileBytes.length);
    payload.set(nameBytes, 0);
    payload[nameBytes.length] = 0;
    payload.set(mimeBytes, nameBytes.length + 1);
    payload[nameBytes.length + 1 + mimeBytes.length] = 0;
    payload.set(fileBytes, nameBytes.length + 1 + mimeBytes.length + 1);
    ws.send(encodeBinaryFrame(BinaryMsgType.FileUpload, selectedAgent, payload));
  }
  // Then send prompt
  if (detail.prompt) {
    send({ type: 'send-prompt', agent: detail.name, prompt: detail.prompt });
  }
});

converterEl.addEventListener('filter-change', function(e) {
  if (selectedAgent && handshakeDone) {
    send({ type: 'follow-agent', agent: selectedAgent, filter: e.detail });
  }
});

// --- WebSocket ---
function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var wsURL = proto + '//' + converterHost + '/ws';
  ws = new WebSocket(wsURL);
  handshakeDone = false;

  ws.onopen = function() {
    statusDot.classList.remove('disconnected');
    statusText.textContent = 'Connected';
    if (agents.size === 0) {
      startAgentsLoading();
    }
    send({ id: 'hello', type: 'hello', protocol: 'tmux-converter.v1' });
  };

  ws.onmessage = function(ev) {
    handleMessage(JSON.parse(ev.data));
  };

  ws.onclose = function() {
    statusDot.classList.add('disconnected');
    statusText.textContent = 'Disconnected';
    handshakeDone = false;
    if (agents.size === 0) {
      startAgentsLoading();
    }
    setTimeout(connect, 2000);
  };

  ws.onerror = function() {};
}

function send(obj) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  if (!obj.id) obj.id = 'req' + (++msgId);
  ws.send(JSON.stringify(obj));
}

// --- Message handling ---
function handleMessage(msg) {
  switch (msg.type) {
    case 'hello':
      if (msg.ok) {
        handshakeDone = true;
        send({ type: 'subscribe-agents' });
        if (selectedAgent) {
          send({ type: 'follow-agent', agent: selectedAgent, filter: converterEl.getFilters() });
        }
      }
      break;

    case 'list-agents':
    case 'subscribe-agents':
      agents.clear();
      if (msg.agents) msg.agents.forEach(function(a) { agents.set(a.name, a); });
      markAgentsLoaded();
      renderAgentList();
      break;

    case 'agent-added':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      renderAgentList();
      break;

    case 'agent-removed':
      var removedName = msg.name || (msg.agent && msg.agent.name);
      if (removedName) {
        agents.delete(removedName);
        if (selectedAgent === removedName) deselectAgent();
      }
      renderAgentList();
      break;

    case 'agent-updated':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      renderAgentList();
      break;

    case 'follow-agent':
      if (msg.ok) {
        currentSubId = msg.subscriptionId;
        if (msg.conversationId) {
          currentConvId = msg.conversationId;
          converterEl.setEvents(msg.events || [], true);
        } else {
          converterEl.showWaiting('No conversation yet \u2014 waiting for activity...');
        }
        updateHeader();
      } else {
        converterEl.showError('Error: ' + (msg.error || 'unknown'));
      }
      break;

    case 'conversation-snapshot':
      currentConvId = msg.conversationId;
      currentSubId = msg.subscriptionId;
      converterEl.setEvents(msg.events || [], true);
      updateHeader();
      break;

    case 'conversation-event':
      if (msg.event && msg.subscriptionId === currentSubId) {
        converterEl.appendEvent(msg.event);
      }
      break;

    case 'conversation-switched':
      currentConvId = msg.to;
      converterEl.addSwitchNotice(msg.from, msg.to);
      break;

    case 'send-prompt':
      if (!msg.ok) console.error('send-prompt error:', msg.error);
      break;

    case 'error':
      console.error('ws error:', msg.error);
      break;
  }
}

// --- Agent list rendering ---
function renderAgentList() {
  clearChildren(agentListEl);

  if (agentsLoading) {
    var loading = document.createElement('div');
    loading.className = 'agent-list-state';
    var spinner = document.createElement('span');
    spinner.className = 'spinner';
    loading.appendChild(spinner);
    var loadingText = document.createElement('span');
    loadingText.textContent = 'Loading agents...';
    loading.appendChild(loadingText);
    agentListEl.appendChild(loading);
    return;
  }

  if (agents.size === 0) {
    var empty = document.createElement('div');
    empty.className = 'agent-list-state' + (agentsLoadTimedOut ? ' timeout' : '');
    empty.textContent = agentsLoadTimedOut ? 'Agent list load timed out' : 'No agents running';
    agentListEl.appendChild(empty);
    return;
  }

  var sorted = Array.from(agents.values()).sort(function(a, b) {
    return a.name.localeCompare(b.name);
  });

  sorted.forEach(function(agent) {
    var card = document.createElement('div');
    card.className = 'agent-card' + (agent.name === selectedAgent ? ' selected' : '');
    card.addEventListener('click', function() { selectAgent(agent.name); });

    var nameRow = document.createElement('div');
    nameRow.className = 'agent-name';
    var nameSpan = document.createElement('span');
    nameSpan.textContent = agent.name;
    nameRow.appendChild(nameSpan);
    card.appendChild(nameRow);

    var metaRow = document.createElement('div');
    metaRow.className = 'agent-meta';
    metaRow.appendChild(createBadge(agent.runtime || '?', 'badge-runtime' + (agent.runtime ? ' ' + agent.runtime : '')));
    card.appendChild(metaRow);

    if (agent.conversationId) {
      var convRow = document.createElement('div');
      convRow.className = 'agent-conv-id';
      convRow.textContent = agent.conversationId;
      card.appendChild(convRow);
    }

    agentListEl.appendChild(card);
  });
}

// --- Agent selection ---
function selectAgent(name) {
  if (selectedAgent === name) {
    if (isMobileLayout()) closeDrawer();
    return;
  }

  // Unfollow previous
  if (selectedAgent) {
    send({ type: 'unsubscribe-agent', agent: selectedAgent });
  }

  selectedAgent = name;
  currentConvId = null;
  currentSubId = null;

  converterEl.setAttribute('name', name);
  converterEl.style.display = '';
  converterEl.showFilters();
  converterEl.showInputArea();
  placeholderEl.style.display = 'none';
  converterEl.clear();
  converterEl.showWaiting('Loading conversation...');

  renderAgentList();
  updateHeader();

  send({ type: 'follow-agent', agent: name, filter: converterEl.getFilters() });

  if (isMobileLayout()) closeDrawer();
}

function deselectAgent() {
  if (selectedAgent) {
    send({ type: 'unsubscribe-agent', agent: selectedAgent });
  }
  selectedAgent = null;
  currentConvId = null;
  currentSubId = null;

  clearChildren(headerContentEl);
  headerContentEl.textContent = 'Select an agent to view conversation';

  converterEl.style.display = 'none';
  converterEl.hideFilters();
  converterEl.hideInputArea();
  converterEl.clearAttachments();
  placeholderEl.style.display = '';

  renderAgentList();
  if (isMobileLayout()) openDrawer();
}

function updateHeader() {
  if (!selectedAgent) return;
  var agent = agents.get(selectedAgent);

  clearChildren(headerContentEl);

  var label = document.createElement('span');
  label.className = 'agent-label';
  label.textContent = selectedAgent;
  headerContentEl.appendChild(label);

  if (agent && agent.runtime) {
    headerContentEl.appendChild(createBadge(agent.runtime, 'badge-runtime ' + agent.runtime));
  }

  if (currentConvId) {
    var convSpan = document.createElement('span');
    convSpan.className = 'header-conv-id';
    convSpan.textContent = currentConvId;
    headerContentEl.appendChild(convSpan);
  }
}

// --- Boot ---
startAgentsLoading();
connect();
if (isMobileLayout() && !selectedAgent) openDrawer();
</script>
</body>
</html>
