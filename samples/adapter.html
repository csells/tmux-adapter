<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gastown Dashboard</title>
<link rel="stylesheet" href="/shared/styles.css">
<style>
  /* Adapter-specific styles */
  .badge-role { color: #0d1117; }
  .badge-attached { background: #1f6feb33; color: #58a6ff; }

  /* Role colors */
  .role-mayor    { background: #da3633; }
  .role-deacon   { background: #a371f7; }
  .role-overseer { background: #58a6ff; }
  .role-witness  { background: #3fb950; }
  .role-refinery { background: #d29922; }
  .role-crew     { background: #f778ba; }
  .role-polecat  { background: #79c0ff; }
  .role-boot     { background: #8b949e; }

  .agent-name { flex-wrap: wrap; }

  .output-wrap {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  @media (max-width: 520px) {
    .agent-card { padding: 9px 10px; }

    .agent-meta {
      font-size: 10px;
      gap: 6px;
    }

    .badge {
      font-size: 9px;
      padding: 1px 5px;
    }
  }
</style>
<script type="importmap">
{ "imports": { "ghostty-web": "https://cdn.jsdelivr.net/npm/ghostty-web/+esm" } }
</script>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <button type="button" class="sidebar-close" id="sidebar-close" aria-label="Close agents drawer">×</button>
      <span class="sidebar-title">Agents</span>
    </div>
    <div class="agent-list" id="agent-list">
      <div class="agent-list-state"><span class="spinner"></span><span>Loading agents...</span></div>
    </div>
  </div>

  <div class="main">
    <div class="main-header" id="main-header">
      <button type="button" class="mobile-nav-btn" id="mobile-nav-btn" aria-label="Open agents drawer">☰</button>
      <div class="header-content" id="header-content">Select an agent to view output</div>
      <button type="button" id="kb-toggle" style="display:none; background:rgba(22,27,34,0.9); border:1px solid #30363d; border-radius:6px; color:#8b949e; font-size:18px; width:36px; height:36px; cursor:pointer; align-items:center; justify-content:center; -webkit-tap-highlight-color:transparent" aria-label="Toggle keyboard">&#x2328;</button>
      <div class="connection-status" id="connection-status">
        <span class="dot disconnected" id="status-dot"></span>
        <span id="status-text">Connecting...</span>
      </div>
    </div>
    <div class="output-wrap" id="output-wrap">
      <div class="placeholder" id="placeholder">Select an agent from the sidebar</div>
    </div>
  </div>
</div>
<div class="drawer-backdrop" id="drawer-backdrop"></div>

<script type="module">
import { init } from 'ghostty-web';
import { clearChildren, createBadge, isMobileLayout, openDrawer, closeDrawer } from '/shared/utils.js';
await init();

var adapterHost = new URLSearchParams(location.search).get('adapter') || location.host || 'localhost:8080';
var adapterOrigin = (location.protocol === 'https:' ? 'https://' : 'http://') + adapterHost;

// Remote debug logging — sends to adapter's /debug/log endpoint
function rlog() {
  var msg = Array.prototype.slice.call(arguments).join(' ');
  console.log('[rlog]', msg);
  navigator.sendBeacon(adapterOrigin + '/debug/log', msg);
}
window.rlog = rlog;

var cacheBust = '?v=' + Date.now();
var { decodeBinaryFrame, encodeBinaryFrame, BinaryMsgType } = await import(adapterOrigin + '/tmux-adapter-web/index.js' + cacheBust);
// --- State ---
var agents = new Map();       // name -> agent object
var selectedAgent = null;     // name of currently selected agent
var msgId = 0;                // monotonic message id
var ws = null;
var textEncoder = new TextEncoder();
var agentsLoading = true;
var agentsLoadTimedOut = false;
var agentsLoadTimer = null;
var AgentsLoadTimeoutMs = 7000;

// --- DOM refs ---
var agentListEl  = document.getElementById('agent-list');
var outputWrapEl = document.getElementById('output-wrap');
var headerContentEl = document.getElementById('header-content');
var placeholderEl = document.getElementById('placeholder');
var statusDot    = document.getElementById('status-dot');
var statusText   = document.getElementById('status-text');
var mobileNavBtn = document.getElementById('mobile-nav-btn');
var sidebarCloseBtn = document.getElementById('sidebar-close');
var drawerBackdropEl = document.getElementById('drawer-backdrop');
var kbToggleBtn = document.getElementById('kb-toggle');
var kbActive = false;

// --- Mobile keyboard toggle ---
var isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
var kbFocusGuardUntil = 0; // timestamp: suppress blur detection while VKB is opening
rlog('touch=' + isTouchDevice + ' selectedAgent=' + selectedAgent);
if (isTouchDevice) {
  kbToggleBtn.style.display = 'flex';
  kbToggleBtn.addEventListener('touchend', function(ev) {
    ev.preventDefault();
    ev.stopPropagation();
    kbActive = !kbActive;
    rlog('kb toggle pressed, kbActive=' + kbActive + ' selectedAgent=' + selectedAgent);
    var el = selectedAgent ? outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(selectedAgent) + '"]') : null;
    if (kbActive && el) {
      // Set a guard window: suppress blur events for 500ms while the VKB opens and triggers resize
      kbFocusGuardUntil = Date.now() + 500;
      rlog('calling focusTextarea with 500ms guard');
      el.focusTextarea();
      // Re-assert focus after resize settles
      setTimeout(function() { if (kbActive && el) { rlog('re-focus after settle'); el.focusTextarea(); } }, 300);
      kbToggleBtn.style.color = '#58a6ff';
      kbToggleBtn.style.borderColor = '#58a6ff';
    } else if (!kbActive && el) {
      rlog('calling blurTextarea');
      el.blurTextarea();
      kbToggleBtn.style.color = '#8b949e';
      kbToggleBtn.style.borderColor = '#30363d';
    }
  });

  // Detect VKB dismiss via blur — but ignore during the guard window
  outputWrapEl.addEventListener('focusout', function(ev) {
    if (kbActive && ev.target && ev.target.tagName === 'TEXTAREA') {
      if (Date.now() < kbFocusGuardUntil) {
        rlog('textarea blur during guard window, ignoring');
        return;
      }
      rlog('textarea blur detected, resetting kbActive');
      kbActive = false;
      kbToggleBtn.style.color = '#8b949e';
      kbToggleBtn.style.borderColor = '#30363d';
    }
  });
}

// --- Terminal event wiring (delegated on outputWrapEl) ---
outputWrapEl.addEventListener('terminal-input', function(e) {
  rlog('terminal-input: ' + e.detail.data.length + ' bytes from ' + e.detail.name);
  sendBinary(BinaryMsgType.KeyboardInput, e.detail.name, e.detail.data);
});

// --- Debug: trace keystroke flow on touch devices ---
if (isTouchDevice) {
  outputWrapEl.addEventListener('keydown', function(e) { rlog('keydown: key=' + e.key + ' target=' + e.target.tagName + '.' + e.target.className); }, true);
  outputWrapEl.addEventListener('beforeinput', function(e) { rlog('beforeinput: type=' + e.inputType + ' data=' + (e.data || '') + ' target=' + e.target.tagName); }, true);
  outputWrapEl.addEventListener('input', function(e) { rlog('input: type=' + e.inputType + ' data=' + (e.data || '') + ' target=' + e.target.tagName); }, true);
  // Check if beforeinput has listeners on the textarea
  outputWrapEl.addEventListener('terminal-ready', function() {
    var termEl = outputWrapEl.querySelector('tmux-adapter-web');
    if (termEl) {
      var ta = termEl.querySelector('textarea');
      rlog('textarea found=' + !!ta + ' focused=' + (document.activeElement === ta));
      if (ta) {
        ta.addEventListener('beforeinput', function(e) { rlog('TA-beforeinput: type=' + e.inputType + ' data=' + (e.data || '')); });
      }
    }
  }, true);
}

outputWrapEl.addEventListener('terminal-resize', function(e) {
  sendBinary(BinaryMsgType.Resize, e.detail.name, textEncoder.encode(e.detail.cols + ':' + e.detail.rows));
});

outputWrapEl.addEventListener('file-upload', function(e) {
  sendBinary(BinaryMsgType.FileUpload, e.detail.name, e.detail.payload);
});

// --- Helpers ---
function clearAgentsLoadTimer() {
  if (!agentsLoadTimer) return;
  clearTimeout(agentsLoadTimer);
  agentsLoadTimer = null;
}

function startAgentsLoading() {
  agentsLoading = true;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
  agentsLoadTimer = setTimeout(function() {
    if (!agentsLoading) return;
    agentsLoading = false;
    agentsLoadTimedOut = true;
    renderAgentList();
  }, AgentsLoadTimeoutMs);
  renderAgentList();
}

function markAgentsLoaded() {
  agentsLoading = false;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
}

function sendResizeNow(agentName) {
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(agentName) + '"]');
  if (!el || !el.cols || !el.rows) return false;
  var payload = textEncoder.encode(el.cols + ':' + el.rows);
  sendBinary(BinaryMsgType.Resize, agentName, payload);
  return true;
}

function subscribeOutputWithSizedSnapshot(agentName) {
  if (!agentName) return;

  requestAnimationFrame(function() {
    sendResizeNow(agentName);
    send({ type: 'subscribe-output', agent: agentName });
  });
}

function syncMobileNavButton() {
  if (!mobileNavBtn) return;
  mobileNavBtn.textContent = '☰';
  mobileNavBtn.setAttribute('aria-label', 'Open agents drawer');
}

function bindMobileLayoutEvents() {
  if (mobileNavBtn) {
    mobileNavBtn.addEventListener('click', function() {
      if (!isMobileLayout()) return;
      openDrawer();
    });
  }

  if (sidebarCloseBtn) {
    sidebarCloseBtn.addEventListener('click', function() {
      closeDrawer();
    });
  }

  if (drawerBackdropEl) {
    drawerBackdropEl.addEventListener('click', function() {
      closeDrawer();
    });
  }

  var media = window.matchMedia('(max-width: 900px)');
  var onChange = function(ev) {
    if (!ev.matches) {
      closeDrawer();
    } else if (!selectedAgent) {
      openDrawer();
    }
    syncMobileNavButton();
  };
  if (typeof media.addEventListener === 'function') {
    media.addEventListener('change', onChange);
  } else if (typeof media.addListener === 'function') {
    media.addListener(onChange);
  }
}

// --- Binary protocol ---
function sendBinary(type, agentName, payload) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(encodeBinaryFrame(type, agentName, payload));
}

function handleBinaryMessage(buffer) {
  var parsed = decodeBinaryFrame(buffer);
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(parsed.agentName) + '"]');
  if (!el) return;
  if (parsed.msgType === BinaryMsgType.TerminalSnapshot) el.reset();
  if (parsed.msgType === BinaryMsgType.TerminalOutput || parsed.msgType === BinaryMsgType.TerminalSnapshot) {
    el.write(parsed.payload);
  }
}

// --- Terminal management ---
function showTerminal(agentName) {
  outputWrapEl.querySelectorAll('tmux-adapter-web').forEach(function(el) {
    el.style.display = 'none';
  });

  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(agentName) + '"]');
  if (!el) {
    el = document.createElement('tmux-adapter-web');
    el.setAttribute('name', agentName);
    outputWrapEl.appendChild(el);
  }
  el.style.display = '';
  placeholderEl.style.display = 'none';

  requestAnimationFrame(function() { el.focus(); });
}

function hideAllTerminals() {
  outputWrapEl.querySelectorAll('tmux-adapter-web').forEach(function(el) {
    el.style.display = 'none';
  });
  placeholderEl.style.display = '';
}

// --- WebSocket ---
function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var wsURL = new URL(proto + '//' + adapterHost + '/ws');
  var token = new URLSearchParams(location.search).get('token');
  if (token) {
    wsURL.searchParams.set('token', token);
  }
  ws = new WebSocket(wsURL.toString());
  ws.binaryType = 'arraybuffer';

  ws.onopen = function() {
    statusDot.classList.remove('disconnected');
    statusText.textContent = 'Connected';
    if (agents.size === 0) {
      startAgentsLoading();
    }
    send({ type: 'subscribe-agents' });

    // Re-subscribe to selected agent's output on reconnect
    if (selectedAgent) {
      var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(selectedAgent) + '"]');
      if (el) el.reset();
      showTerminal(selectedAgent);
      subscribeOutputWithSizedSnapshot(selectedAgent);
    }
  };

  ws.onclose = function() {
    statusDot.classList.add('disconnected');
    statusText.textContent = 'Disconnected';
    if (agents.size === 0) {
      startAgentsLoading();
    }
    setTimeout(connect, 2000);
  };

  ws.onmessage = function(ev) {
    if (typeof ev.data === 'string') {
      handleJsonMessage(JSON.parse(ev.data));
    } else if (ev.data instanceof ArrayBuffer) {
      handleBinaryMessage(ev.data);
    }
  };
}

function send(obj) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return null;
  obj.id = String(++msgId);
  ws.send(JSON.stringify(obj));
  return obj.id;
}

// --- JSON message handling ---
function handleJsonMessage(msg) {
  switch (msg.type) {
    case 'subscribe-agents':
      agents.clear();
      if (msg.agents) msg.agents.forEach(function(a) { agents.set(a.name, a); });
      markAgentsLoaded();
      renderAgentList();
      break;

    case 'agent-added':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      renderAgentList();
      break;

    case 'agent-removed':
      var removedName = msg.name || (msg.agent && msg.agent.name);
      if (removedName) {
        agents.delete(removedName);
        var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(removedName) + '"]');
        if (el) el.remove(); // disconnectedCallback handles cleanup
        if (selectedAgent === removedName) deselectAgent();
      }
      renderAgentList();
      break;

    case 'agent-updated':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      renderAgentList();
      if (msg.agent && msg.agent.name === selectedAgent) updateHeader();
      break;

    case 'subscribe-output':
      break;

    case 'send-prompt':
      break;

    case 'error':
      console.error('ws error:', msg.error || msg);
      break;
  }
}

// --- Agent list rendering (safe DOM methods) ---
function renderAgentList() {
  clearChildren(agentListEl);

  if (agentsLoading) {
    var loading = document.createElement('div');
    loading.className = 'agent-list-state';
    var spinner = document.createElement('span');
    spinner.className = 'spinner';
    loading.appendChild(spinner);
    var loadingText = document.createElement('span');
    loadingText.textContent = 'Loading agents...';
    loading.appendChild(loadingText);
    agentListEl.appendChild(loading);
    return;
  }

  if (agents.size === 0) {
    var empty = document.createElement('div');
    empty.className = 'agent-list-state' + (agentsLoadTimedOut ? ' timeout' : '');
    empty.textContent = agentsLoadTimedOut ? 'Agent list load timed out' : 'No agents running';
    agentListEl.appendChild(empty);
    return;
  }

  var sorted = Array.from(agents.values()).sort(function(a, b) {
    return a.name.localeCompare(b.name);
  });

  sorted.forEach(function(agent) {
    var card = document.createElement('div');
    card.className = 'agent-card' + (agent.name === selectedAgent ? ' selected' : '');
    card.addEventListener('click', function() { selectAgent(agent.name); });

    // Name row
    var nameRow = document.createElement('div');
    nameRow.className = 'agent-name';
    nameRow.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));
    var nameSpan = document.createElement('span');
    nameSpan.textContent = agent.name;
    nameRow.appendChild(nameSpan);
    card.appendChild(nameRow);

    // Meta row
    var metaRow = document.createElement('div');
    metaRow.className = 'agent-meta';
    metaRow.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));
    if (agent.attached) {
      metaRow.appendChild(createBadge('attached', 'badge badge-attached'));
    }
    card.appendChild(metaRow);

    agentListEl.appendChild(card);
  });
}

// --- Agent selection ---
function selectAgent(name) {
  if (selectedAgent === name) {
    if (isMobileLayout()) {
      closeDrawer();
    }
    syncMobileNavButton();
    return;
  }

  // Unsubscribe from previous
  if (selectedAgent) {
    send({ type: 'unsubscribe-output', agent: selectedAgent });
  }

  selectedAgent = name;

  // Reset terminal for fresh snapshot on re-select
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(name) + '"]');
  if (el) el.reset();

  updateHeader();
  renderAgentList();

  showTerminal(name);
  subscribeOutputWithSizedSnapshot(name);

  if (isMobileLayout()) {
    closeDrawer();
  }
  syncMobileNavButton();
}

function deselectAgent() {
  selectedAgent = null;
  hideAllTerminals();

  clearChildren(headerContentEl);
  headerContentEl.textContent = 'Select an agent to view output';

  renderAgentList();
  if (isMobileLayout()) {
    openDrawer();
  }
  syncMobileNavButton();
}

function updateHeader() {
  if (!selectedAgent) return;
  var agent = agents.get(selectedAgent);
  if (!agent) return;

  clearChildren(headerContentEl);
  headerContentEl.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));

  var label = document.createElement('span');
  label.className = 'agent-label';
  label.textContent = agent.name;
  headerContentEl.appendChild(label);

  headerContentEl.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));

  if (agent.attached) {
    headerContentEl.appendChild(createBadge('attached', 'badge badge-attached'));
  }

  syncMobileNavButton();
}

// --- Virtual keyboard viewport adjustment ---
if (window.visualViewport) {
  var containerEl = document.querySelector('.container');
  window.visualViewport.addEventListener('resize', function() {
    // When VKB appears, visualViewport.height shrinks. Resize the layout to fit.
    containerEl.style.height = window.visualViewport.height + 'px';
  });
  window.visualViewport.addEventListener('scroll', function() {
    // Prevent the page from scrolling behind the keyboard
    window.scrollTo(0, 0);
  });
}

// --- Boot ---
bindMobileLayoutEvents();
startAgentsLoading();
connect();
syncMobileNavButton();
if (isMobileLayout() && !selectedAgent) {
  openDrawer();
}
</script>
</body>
</html>
