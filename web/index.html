<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gastown Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
    background: #0d1117;
    color: #c9d1d9;
    height: 100vh;
    overflow: hidden;
  }

  .container {
    display: grid;
    grid-template-columns: 260px 1fr;
    height: 100vh;
  }

  /* --- Left panel: agent list --- */
  .sidebar {
    background: #161b22;
    border-right: 1px solid #30363d;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid #30363d;
    font-size: 14px;
    font-weight: 600;
    color: #58a6ff;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sidebar-header .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #3fb950;
    flex-shrink: 0;
  }

  .sidebar-header .dot.disconnected { background: #f85149; }

  .agent-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .agent-card {
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 4px;
    border: 1px solid transparent;
    transition: background 0.15s, border-color 0.15s;
  }

  .agent-card:hover { background: #1c2128; }
  .agent-card.selected { background: #1c2128; border-color: #58a6ff; }

  .agent-name {
    font-size: 13px;
    font-weight: 600;
    color: #e6edf3;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .agent-meta {
    font-size: 11px;
    color: #8b949e;
    margin-top: 4px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-role {
    color: #0d1117;
  }

  .badge-attached {
    background: #1f6feb33;
    color: #58a6ff;
  }

  .badge-runtime {
    color: #8b949e;
  }

  /* Role colors */
  .role-mayor    { background: #da3633; }
  .role-deacon   { background: #a371f7; }
  .role-overseer { background: #58a6ff; }
  .role-witness  { background: #3fb950; }
  .role-refinery { background: #d29922; }
  .role-crew     { background: #f778ba; }
  .role-polecat  { background: #79c0ff; }
  .role-boot     { background: #8b949e; }

  /* --- Right panel: output viewer --- */
  .main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .main-header {
    padding: 12px 16px;
    border-bottom: 1px solid #30363d;
    font-size: 13px;
    color: #8b949e;
    background: #161b22;
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 44px;
  }

  .main-header .agent-label {
    color: #e6edf3;
    font-weight: 600;
  }

  .output-wrap {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  .output {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding: 16px;
    font-size: 13px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #c9d1d9;
    scrollbar-width: thin;
    scrollbar-color: #30363d #0d1117;
  }

  .output::-webkit-scrollbar { width: 8px; }
  .output::-webkit-scrollbar-track { background: #0d1117; }
  .output::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }

  .placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #484f58;
    font-size: 14px;
  }

  .prompt-bar {
    display: flex;
    border-top: 1px solid #30363d;
    background: #161b22;
    padding: 10px 16px;
    gap: 8px;
  }

  .prompt-bar input {
    flex: 1;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 8px 12px;
    color: #e6edf3;
    font-family: inherit;
    font-size: 13px;
    outline: none;
  }

  .prompt-bar input:focus { border-color: #58a6ff; }
  .prompt-bar input:disabled { opacity: 0.4; }

  .prompt-bar button {
    background: #238636;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    color: #fff;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }

  .prompt-bar button:hover { background: #2ea043; }
  .prompt-bar button:disabled { opacity: 0.4; cursor: default; }

  .empty-sidebar {
    padding: 16px;
    color: #484f58;
    font-size: 12px;
    text-align: center;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="dot disconnected" id="status-dot"></span>
      <span id="status-text">Connecting...</span>
    </div>
    <div class="agent-list" id="agent-list">
      <div class="empty-sidebar">No agents running</div>
    </div>
  </div>

  <div class="main">
    <div class="main-header" id="main-header">
      Select an agent to view output
    </div>
    <div class="output-wrap">
      <div id="output" class="output">
        <div class="placeholder">Select an agent from the sidebar</div>
      </div>
    </div>
    <div class="prompt-bar">
      <input type="text" id="prompt-input" placeholder="Send a prompt..." disabled>
      <button id="send-btn" disabled>Send</button>
    </div>
  </div>
</div>

<script>
(function() {
  // --- State ---
  var agents = new Map();       // name -> agent object
  var selectedAgent = null;     // name of currently selected agent
  var msgId = 0;                // monotonic message id
  var ws = null;
  var userScrolledUp = false;

  // --- DOM refs ---
  var agentListEl  = document.getElementById('agent-list');
  var outputEl     = document.getElementById('output');
  var mainHeaderEl = document.getElementById('main-header');
  var promptInput  = document.getElementById('prompt-input');
  var sendBtn      = document.getElementById('send-btn');
  var statusDot    = document.getElementById('status-dot');
  var statusText   = document.getElementById('status-text');

  // --- Helpers: safe DOM construction ---
  function createBadge(text, classNames) {
    var el = document.createElement('span');
    el.textContent = text;
    el.className = classNames;
    return el;
  }

  function clearChildren(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  // --- WebSocket ---
  function connect() {
    var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws');

    ws.onopen = function() {
      statusDot.classList.remove('disconnected');
      statusText.textContent = 'Connected';
      send({ type: 'subscribe-agents' });
    };

    ws.onclose = function() {
      statusDot.classList.add('disconnected');
      statusText.textContent = 'Disconnected';
      setTimeout(connect, 2000);
    };

    ws.onmessage = function(ev) {
      var msg = JSON.parse(ev.data);
      handleMessage(msg);
    };
  }

  function send(obj) {
    obj.id = String(++msgId);
    ws.send(JSON.stringify(obj));
    return obj.id;
  }

  // --- Message handling ---
  function handleMessage(msg) {
    switch (msg.type) {
      case 'subscribe-agents':
        if (msg.agents) msg.agents.forEach(function(a) { agents.set(a.name, a); });
        renderAgentList();
        break;

      case 'agent-added':
        if (msg.agent) agents.set(msg.agent.name, msg.agent);
        renderAgentList();
        break;

      case 'agent-removed':
        var removedName = msg.name || (msg.agent && msg.agent.name);
        if (removedName) {
          agents.delete(removedName);
          if (selectedAgent === removedName) deselectAgent();
        }
        renderAgentList();
        break;

      case 'agent-updated':
        if (msg.agent) agents.set(msg.agent.name, msg.agent);
        renderAgentList();
        if (msg.agent && msg.agent.name === selectedAgent) updateHeader();
        break;

      case 'subscribe-output':
        if (msg.history !== undefined) {
          outputEl.textContent = msg.history;
          scrollToBottom();
        }
        break;

      case 'output':
        if (msg.name === selectedAgent && msg.data) {
          outputEl.textContent += msg.data;
          if (!userScrolledUp) scrollToBottom();
        }
        break;

      case 'send-prompt':
        // response to our send; nothing to do on success
        break;
    }
  }

  // --- Agent list rendering (safe DOM methods) ---
  function renderAgentList() {
    clearChildren(agentListEl);

    if (agents.size === 0) {
      var empty = document.createElement('div');
      empty.className = 'empty-sidebar';
      empty.textContent = 'No agents running';
      agentListEl.appendChild(empty);
      return;
    }

    var sorted = Array.from(agents.values()).sort(function(a, b) {
      return a.name.localeCompare(b.name);
    });

    sorted.forEach(function(agent) {
      var card = document.createElement('div');
      card.className = 'agent-card' + (agent.name === selectedAgent ? ' selected' : '');
      card.addEventListener('click', function() { selectAgent(agent.name); });

      // Name row
      var nameRow = document.createElement('div');
      nameRow.className = 'agent-name';
      nameRow.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));
      var nameSpan = document.createElement('span');
      nameSpan.textContent = agent.name;
      nameRow.appendChild(nameSpan);
      card.appendChild(nameRow);

      // Meta row
      var metaRow = document.createElement('div');
      metaRow.className = 'agent-meta';
      metaRow.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));
      if (agent.attached) {
        metaRow.appendChild(createBadge('attached', 'badge badge-attached'));
      }
      card.appendChild(metaRow);

      agentListEl.appendChild(card);
    });
  }

  // --- Agent selection ---
  function selectAgent(name) {
    if (selectedAgent === name) return;

    // Unsubscribe from previous
    if (selectedAgent) {
      send({ type: 'unsubscribe-output', agent: selectedAgent });
    }

    selectedAgent = name;
    outputEl.textContent = '';
    userScrolledUp = false;
    updateHeader();
    renderAgentList();

    // Enable prompt
    promptInput.disabled = false;
    sendBtn.disabled = false;

    // Subscribe to new agent output
    send({ type: 'subscribe-output', agent: name });
  }

  function deselectAgent() {
    selectedAgent = null;
    clearChildren(outputEl);
    var ph = document.createElement('div');
    ph.className = 'placeholder';
    ph.textContent = 'Select an agent from the sidebar';
    outputEl.appendChild(ph);

    clearChildren(mainHeaderEl);
    mainHeaderEl.textContent = 'Select an agent to view output';

    promptInput.disabled = true;
    sendBtn.disabled = true;
    renderAgentList();
  }

  function updateHeader() {
    if (!selectedAgent) return;
    var agent = agents.get(selectedAgent);
    if (!agent) return;

    clearChildren(mainHeaderEl);
    mainHeaderEl.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));

    var label = document.createElement('span');
    label.className = 'agent-label';
    label.textContent = agent.name;
    mainHeaderEl.appendChild(label);

    mainHeaderEl.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));

    if (agent.attached) {
      mainHeaderEl.appendChild(createBadge('attached', 'badge badge-attached'));
    }
  }

  // --- Prompt sending ---
  function sendPrompt() {
    var text = promptInput.value.trim();
    if (!text || !selectedAgent) return;
    send({ type: 'send-prompt', agent: selectedAgent, prompt: text });
    promptInput.value = '';
  }

  sendBtn.addEventListener('click', sendPrompt);
  promptInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') sendPrompt();
  });

  // --- Auto-scroll ---
  outputEl.addEventListener('scroll', function() {
    userScrolledUp = (outputEl.scrollHeight - outputEl.scrollTop - outputEl.clientHeight) > 50;
  });

  function scrollToBottom() {
    outputEl.scrollTop = outputEl.scrollHeight;
  }

  // --- Boot ---
  connect();
})();
</script>
</body>
</html>
