<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gastown Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
    background: #0d1117;
    color: #c9d1d9;
    height: 100vh;
    overflow: hidden;
  }

  .container {
    display: grid;
    grid-template-columns: 260px 1fr;
    height: 100vh;
  }

  /* --- Left panel: agent list --- */
  .sidebar {
    background: #161b22;
    border-right: 1px solid #30363d;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid #30363d;
    font-size: 14px;
    font-weight: 600;
    color: #58a6ff;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sidebar-header .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #3fb950;
    flex-shrink: 0;
  }

  .sidebar-header .dot.disconnected { background: #f85149; }

  .agent-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .agent-card {
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 4px;
    border: 1px solid transparent;
    transition: background 0.15s, border-color 0.15s;
  }

  .agent-card:hover { background: #1c2128; }
  .agent-card.selected { background: #1c2128; border-color: #58a6ff; }

  .agent-name {
    font-size: 13px;
    font-weight: 600;
    color: #e6edf3;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .agent-meta {
    font-size: 11px;
    color: #8b949e;
    margin-top: 4px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-role {
    color: #0d1117;
  }

  .badge-attached {
    background: #1f6feb33;
    color: #58a6ff;
  }

  .badge-runtime {
    color: #8b949e;
  }

  /* Role colors */
  .role-mayor    { background: #da3633; }
  .role-deacon   { background: #a371f7; }
  .role-overseer { background: #58a6ff; }
  .role-witness  { background: #3fb950; }
  .role-refinery { background: #d29922; }
  .role-crew     { background: #f778ba; }
  .role-polecat  { background: #79c0ff; }
  .role-boot     { background: #8b949e; }

  /* --- Right panel: output viewer --- */
  .main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .main-header {
    padding: 12px 16px;
    border-bottom: 1px solid #30363d;
    font-size: 13px;
    color: #8b949e;
    background: #161b22;
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 44px;
  }

  .main-header .agent-label {
    color: #e6edf3;
    font-weight: 600;
  }

  .output-wrap {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  .output {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding: 0;
    font-size: 13px;
    line-height: 1.5;
    color: #c9d1d9;
    scrollbar-width: thin;
    scrollbar-color: #30363d #0d1117;
    display: flex;
    flex-direction: column;
  }

  .output::-webkit-scrollbar { width: 8px; }
  .output::-webkit-scrollbar-track { background: #0d1117; }
  .output::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }

  .scrollback {
    padding: 8px 16px 0 16px;
    flex-shrink: 0;
  }

  .scrollback .screen-row {
    height: 1.5em;
    white-space: pre;
    overflow: hidden;
  }

  .screen-grid {
    padding: 4px 16px;
    flex-shrink: 0;
  }

  .screen-grid .screen-row {
    height: 1.5em;
    white-space: pre;
    overflow: hidden;
  }

  .screen-grid .screen-cursor {
    background: #c9d1d9;
    color: #0d1117;
  }

  .placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #484f58;
    font-size: 14px;
  }

  .prompt-bar {
    display: flex;
    border-top: 1px solid #30363d;
    background: #161b22;
    padding: 10px 16px;
    gap: 8px;
  }

  .prompt-bar input {
    flex: 1;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 8px 12px;
    color: #e6edf3;
    font-family: inherit;
    font-size: 13px;
    outline: none;
  }

  .prompt-bar input:focus { border-color: #58a6ff; }
  .prompt-bar input:disabled { opacity: 0.4; }

  .prompt-bar button {
    background: #238636;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    color: #fff;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }

  .prompt-bar button:hover { background: #2ea043; }
  .prompt-bar button:disabled { opacity: 0.4; cursor: default; }

  .empty-sidebar {
    padding: 16px;
    color: #484f58;
    font-size: 12px;
    text-align: center;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="dot disconnected" id="status-dot"></span>
      <span id="status-text">Connecting...</span>
    </div>
    <div class="agent-list" id="agent-list">
      <div class="empty-sidebar">No agents running</div>
    </div>
  </div>

  <div class="main">
    <div class="main-header" id="main-header">
      Select an agent to view output
    </div>
    <div class="output-wrap">
      <div id="output" class="output">
        <div class="placeholder">Select an agent from the sidebar</div>
      </div>
    </div>
    <div class="prompt-bar">
      <input type="text" id="prompt-input" placeholder="Send a prompt..." disabled>
      <button id="send-btn" disabled>Send</button>
    </div>
  </div>
</div>

<script>
(function() {
  // --- State ---
  var agents = new Map();       // name -> agent object
  var selectedAgent = null;     // name of currently selected agent
  var msgId = 0;                // monotonic message id
  var ws = null;
  var userScrolledUp = false;
  var screenRows = new Map();   // row index -> raw text with ANSI codes
  var screenMeta = { cols: 80, numRows: 24, cursor: [0, 0] };
  var pendingPrompt = null;     // queued prompt for retry on reconnect

  // --- DOM refs ---
  var agentListEl  = document.getElementById('agent-list');
  var outputEl     = document.getElementById('output');
  var mainHeaderEl = document.getElementById('main-header');
  var promptInput  = document.getElementById('prompt-input');
  var sendBtn      = document.getElementById('send-btn');
  var statusDot    = document.getElementById('status-dot');
  var statusText   = document.getElementById('status-text');

  // Scrollback and screen-grid containers (created on demand)
  var scrollbackEl = null;
  var screenGridEl = null;

  // --- ANSI SGR color tables ---
  var STANDARD_COLORS = ['#282c34','#e06c75','#98c379','#e5c07b','#61afef','#c678dd','#56b6c2','#abb2bf'];
  var BRIGHT_COLORS   = ['#5c6370','#be5046','#7ec168','#d19a66','#528bff','#b668cd','#3fc5d4','#ffffff'];

  function color256(n) {
    if (n < 8) return STANDARD_COLORS[n];
    if (n < 16) return BRIGHT_COLORS[n - 8];
    if (n < 232) {
      var idx = n - 16;
      var b = idx % 6; idx = (idx - b) / 6;
      var g = idx % 6; idx = (idx - g) / 6;
      var r = idx;
      var toHex = function(v) { var h = (v === 0 ? 0 : 55 + v * 40).toString(16); return h.length < 2 ? '0' + h : h; };
      return '#' + toHex(r) + toHex(g) + toHex(b);
    }
    var level = 8 + (n - 232) * 10;
    var hex = level.toString(16);
    if (hex.length < 2) hex = '0' + hex;
    return '#' + hex + hex + hex;
  }

  // --- ANSI SGR parser ---
  function parseAnsiRow(text) {
    var spans = [];
    var state = { bold: false, italic: false, underline: false, fg: null, bg: null };
    var re = /\x1b\[([\d;]*)m/g;
    var lastIndex = 0;
    var match;

    function makeSpan(str) {
      var span = document.createElement('span');
      span.textContent = str;
      var styles = '';
      if (state.bold) styles += 'font-weight:bold;';
      if (state.italic) styles += 'font-style:italic;';
      if (state.underline) styles += 'text-decoration:underline;';
      if (state.fg) styles += 'color:' + state.fg + ';';
      if (state.bg) styles += 'background:' + state.bg + ';';
      if (styles) span.setAttribute('style', styles);
      return span;
    }

    while ((match = re.exec(text)) !== null) {
      if (match.index > lastIndex) {
        spans.push(makeSpan(text.substring(lastIndex, match.index)));
      }
      lastIndex = re.lastIndex;

      var params = match[1] === '' ? [0] : match[1].split(';').map(Number);
      for (var i = 0; i < params.length; i++) {
        var p = params[i];
        if (p === 0) {
          state.bold = false; state.italic = false; state.underline = false;
          state.fg = null; state.bg = null;
        } else if (p === 1) {
          state.bold = true;
        } else if (p === 3) {
          state.italic = true;
        } else if (p === 4) {
          state.underline = true;
        } else if (p === 22) {
          state.bold = false;
        } else if (p === 23) {
          state.italic = false;
        } else if (p === 24) {
          state.underline = false;
        } else if (p >= 30 && p <= 37) {
          state.fg = STANDARD_COLORS[p - 30];
        } else if (p === 38) {
          if (params[i + 1] === 5 && i + 2 < params.length) {
            state.fg = color256(params[i + 2]);
            i += 2;
          } else if (params[i + 1] === 2 && i + 4 < params.length) {
            state.fg = 'rgb(' + params[i + 2] + ',' + params[i + 3] + ',' + params[i + 4] + ')';
            i += 4;
          }
        } else if (p === 39) {
          state.fg = null;
        } else if (p >= 40 && p <= 47) {
          state.bg = STANDARD_COLORS[p - 40];
        } else if (p === 48) {
          if (params[i + 1] === 5 && i + 2 < params.length) {
            state.bg = color256(params[i + 2]);
            i += 2;
          } else if (params[i + 1] === 2 && i + 4 < params.length) {
            state.bg = 'rgb(' + params[i + 2] + ',' + params[i + 3] + ',' + params[i + 4] + ')';
            i += 4;
          }
        } else if (p === 49) {
          state.bg = null;
        } else if (p >= 90 && p <= 97) {
          state.fg = BRIGHT_COLORS[p - 90];
        }
      }
    }

    if (lastIndex < text.length) {
      spans.push(makeSpan(text.substring(lastIndex)));
    }

    if (spans.length === 0) {
      spans.push(document.createElement('span'));
    }

    return spans;
  }

  // --- Screen rendering ---
  function ensureScreenLayout() {
    if (scrollbackEl && screenGridEl) return;

    clearChildren(outputEl);
    scrollbackEl = document.createElement('div');
    scrollbackEl.className = 'scrollback';
    outputEl.appendChild(scrollbackEl);

    screenGridEl = document.createElement('div');
    screenGridEl.className = 'screen-grid';
    outputEl.appendChild(screenGridEl);

    for (var i = 0; i < screenMeta.numRows; i++) {
      var row = document.createElement('div');
      row.className = 'screen-row';
      row.appendChild(document.createElement('span'));
      screenGridEl.appendChild(row);
    }
  }

  function renderScreenRow(rowIndex) {
    if (!screenGridEl) return;
    if (rowIndex < 0 || rowIndex >= screenMeta.numRows) return;
    var rowDiv = screenGridEl.children[rowIndex];
    if (!rowDiv) return;
    clearChildren(rowDiv);
    var text = screenRows.get(rowIndex) || '';
    var spans = parseAnsiRow(text);
    spans.forEach(function(span) { rowDiv.appendChild(span); });
  }

  function renderFullScreen(screenData) {
    if (!screenData) return;
    screenMeta.cols = screenData.cols || 80;
    screenMeta.numRows = screenData.numRows || 24;
    screenMeta.cursor = screenData.cursor || [0, 0];

    if (screenGridEl && screenGridEl.children.length !== screenMeta.numRows) {
      clearChildren(screenGridEl);
      for (var i = 0; i < screenMeta.numRows; i++) {
        var row = document.createElement('div');
        row.className = 'screen-row';
        row.appendChild(document.createElement('span'));
        screenGridEl.appendChild(row);
      }
    }

    screenRows.clear();
    if (screenData.rows) {
      var keys = Object.keys(screenData.rows);
      for (var k = 0; k < keys.length; k++) {
        screenRows.set(Number(keys[k]), screenData.rows[keys[k]]);
      }
    }

    for (var r = 0; r < screenMeta.numRows; r++) {
      renderScreenRow(r);
    }
  }

  function applyScreenUpdate(msg) {
    if (msg.cursor) screenMeta.cursor = msg.cursor;
    if (msg.rows) {
      var keys = Object.keys(msg.rows);
      for (var k = 0; k < keys.length; k++) {
        var idx = Number(keys[k]);
        screenRows.set(idx, msg.rows[keys[k]]);
        renderScreenRow(idx);
      }
    }
  }

  // --- History rendering ---
  function renderHistory(text) {
    if (!scrollbackEl) return;
    clearChildren(scrollbackEl);
    var lines = text.split('\n');
    for (var i = 0; i < lines.length; i++) {
      var lineDiv = document.createElement('div');
      lineDiv.className = 'screen-row';
      var spans = parseAnsiRow(lines[i]);
      spans.forEach(function(span) { lineDiv.appendChild(span); });
      scrollbackEl.appendChild(lineDiv);
    }
  }

  // --- Helpers: safe DOM construction ---
  function createBadge(text, classNames) {
    var el = document.createElement('span');
    el.textContent = text;
    el.className = classNames;
    return el;
  }

  function clearChildren(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  // --- WebSocket ---
  function connect() {
    var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws');

    ws.onopen = function() {
      statusDot.classList.remove('disconnected');
      statusText.textContent = 'Connected';
      send({ type: 'subscribe-agents' });

      // Re-subscribe to selected agent's output
      if (selectedAgent) {
        clearChildren(outputEl);
        scrollbackEl = null;
        screenGridEl = null;
        screenRows.clear();
        send({ type: 'subscribe-output', agent: selectedAgent });
      }

      // Flush pending prompt
      if (pendingPrompt) {
        var p = pendingPrompt;
        pendingPrompt = null;
        promptInput.placeholder = 'Send a prompt...';
        send({ type: 'send-prompt', agent: p.agent, prompt: p.prompt });
      }
    };

    ws.onclose = function() {
      statusDot.classList.add('disconnected');
      statusText.textContent = 'Disconnected';

      // If a send-prompt was in flight, re-queue it
      if (pendingSendId) {
        pendingSendId = null;
        var text = promptInput.value.trim();
        if (text && selectedAgent) {
          pendingPrompt = { agent: selectedAgent, prompt: text };
          promptInput.value = '';
          promptInput.placeholder = 'Queued — will send on reconnect...';
        }
        promptInput.disabled = false;
        sendBtn.disabled = false;
      }

      setTimeout(connect, 2000);
    };

    ws.onmessage = function(ev) {
      var msg = JSON.parse(ev.data);
      handleMessage(msg);
    };
  }

  function send(obj) {
    if (!ws || ws.readyState !== WebSocket.OPEN) return null;
    obj.id = String(++msgId);
    ws.send(JSON.stringify(obj));
    return obj.id;
  }

  // --- Message handling ---
  function handleMessage(msg) {
    switch (msg.type) {
      case 'subscribe-agents':
        if (msg.agents) msg.agents.forEach(function(a) { agents.set(a.name, a); });
        renderAgentList();
        break;

      case 'agent-added':
        if (msg.agent) agents.set(msg.agent.name, msg.agent);
        renderAgentList();
        break;

      case 'agent-removed':
        var removedName = msg.name || (msg.agent && msg.agent.name);
        if (removedName) {
          agents.delete(removedName);
          if (selectedAgent === removedName) deselectAgent();
        }
        renderAgentList();
        break;

      case 'agent-updated':
        if (msg.agent) agents.set(msg.agent.name, msg.agent);
        renderAgentList();
        if (msg.agent && msg.agent.name === selectedAgent) updateHeader();
        break;

      case 'subscribe-output':
        ensureScreenLayout();
        if (msg.history !== undefined) {
          renderHistory(msg.history);
        }
        if (msg.screen) {
          renderFullScreen(msg.screen);
        }
        scrollToBottom();
        break;

      case 'screen-update':
        if (msg.name === selectedAgent) {
          applyScreenUpdate(msg);
          if (!userScrolledUp) scrollToBottom();
        }
        break;

      case 'output':
        // Backward compat fallback for raw byte streaming
        if (msg.name === selectedAgent && msg.data) {
          ensureScreenLayout();
          scrollbackEl.textContent += msg.data;
          if (!userScrolledUp) scrollToBottom();
        }
        break;

      case 'send-prompt':
        if (msg.id === pendingSendId) {
          pendingSendId = null;
          promptInput.disabled = false;
          sendBtn.disabled = false;
          if (msg.ok) {
            promptInput.value = '';
          } else {
            // Show error — keep text in input so user can retry
            promptInput.placeholder = 'Error: ' + (msg.error || 'send failed') + ' — try again';
          }
          promptInput.focus();
        }
        break;
    }
  }

  // --- Agent list rendering (safe DOM methods) ---
  function renderAgentList() {
    clearChildren(agentListEl);

    if (agents.size === 0) {
      var empty = document.createElement('div');
      empty.className = 'empty-sidebar';
      empty.textContent = 'No agents running';
      agentListEl.appendChild(empty);
      return;
    }

    var sorted = Array.from(agents.values()).sort(function(a, b) {
      return a.name.localeCompare(b.name);
    });

    sorted.forEach(function(agent) {
      var card = document.createElement('div');
      card.className = 'agent-card' + (agent.name === selectedAgent ? ' selected' : '');
      card.addEventListener('click', function() { selectAgent(agent.name); });

      // Name row
      var nameRow = document.createElement('div');
      nameRow.className = 'agent-name';
      nameRow.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));
      var nameSpan = document.createElement('span');
      nameSpan.textContent = agent.name;
      nameRow.appendChild(nameSpan);
      card.appendChild(nameRow);

      // Meta row
      var metaRow = document.createElement('div');
      metaRow.className = 'agent-meta';
      metaRow.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));
      if (agent.attached) {
        metaRow.appendChild(createBadge('attached', 'badge badge-attached'));
      }
      card.appendChild(metaRow);

      agentListEl.appendChild(card);
    });
  }

  // --- Agent selection ---
  function selectAgent(name) {
    if (selectedAgent === name) return;

    // Unsubscribe from previous
    if (selectedAgent) {
      send({ type: 'unsubscribe-output', agent: selectedAgent });
    }

    selectedAgent = name;
    clearChildren(outputEl);
    scrollbackEl = null;
    screenGridEl = null;
    screenRows.clear();
    userScrolledUp = false;
    updateHeader();
    renderAgentList();

    // Enable prompt
    promptInput.disabled = false;
    sendBtn.disabled = false;

    // Subscribe to new agent output
    send({ type: 'subscribe-output', agent: name });
  }

  function deselectAgent() {
    selectedAgent = null;
    scrollbackEl = null;
    screenGridEl = null;
    screenRows.clear();
    clearChildren(outputEl);
    var ph = document.createElement('div');
    ph.className = 'placeholder';
    ph.textContent = 'Select an agent from the sidebar';
    outputEl.appendChild(ph);

    clearChildren(mainHeaderEl);
    mainHeaderEl.textContent = 'Select an agent to view output';

    promptInput.disabled = true;
    sendBtn.disabled = true;
    renderAgentList();
  }

  function updateHeader() {
    if (!selectedAgent) return;
    var agent = agents.get(selectedAgent);
    if (!agent) return;

    clearChildren(mainHeaderEl);
    mainHeaderEl.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));

    var label = document.createElement('span');
    label.className = 'agent-label';
    label.textContent = agent.name;
    mainHeaderEl.appendChild(label);

    mainHeaderEl.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));

    if (agent.attached) {
      mainHeaderEl.appendChild(createBadge('attached', 'badge badge-attached'));
    }
  }

  // --- Prompt sending ---
  var pendingSendId = null;  // id of in-flight send-prompt

  function sendPrompt() {
    var text = promptInput.value.trim();
    if (!text || !selectedAgent) return;
    if (pendingSendId) return; // already waiting for a response

    var id = send({ type: 'send-prompt', agent: selectedAgent, prompt: text });
    if (id) {
      // Keep text in input until server confirms
      pendingSendId = id;
      promptInput.disabled = true;
      sendBtn.disabled = true;
    } else {
      // Queue for retry on reconnect
      pendingPrompt = { agent: selectedAgent, prompt: text };
      promptInput.placeholder = 'Queued — will send on reconnect...';
    }
  }

  sendBtn.addEventListener('click', sendPrompt);
  promptInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') sendPrompt();
  });

  // --- Auto-scroll ---
  outputEl.addEventListener('scroll', function() {
    userScrolledUp = (outputEl.scrollHeight - outputEl.scrollTop - outputEl.clientHeight) > 50;
  });

  function scrollToBottom() {
    outputEl.scrollTop = outputEl.scrollHeight;
  }

  // --- Boot ---
  connect();
})();
</script>
</body>
</html>
